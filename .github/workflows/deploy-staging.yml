name: Deploy to Cloudflare (Staging)

on:
  release:
    types: [published]

permissions:
  contents: write # Required to edit releases

jobs:
  deploy_staging:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Inject D1 database IDs into Wrangler config
        env:
          CF_D1_SEARCH_DB_ID_PROD: ${{ secrets.CF_D1_SEARCH_DB_ID_PROD }}
          CF_D1_SEARCH_DB_ID_PREVIEW: ${{ secrets.CF_D1_SEARCH_DB_ID_PREVIEW }}
        run: node scripts/ci/inject-d1-database-ids.mjs

      - name: Build search index (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NEXT_PUBLIC_GIT_TAG: ${{ github.event.release.tag_name }}
        run: npm run build:search

      - name: Deploy to Cloudflare (staging)
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NEXT_PUBLIC_SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL }}
          NEXT_PUBLIC_GIT_TAG: ${{ github.event.release.tag_name }}
        run: |
          LOG=$(npm run upload -- --env="" --preview-alias staging --tag $NEXT_PUBLIC_GIT_TAG 2>&1 | tee /dev/stderr)
          VERSION_ID=$(echo "$LOG" | grep -oE 'Worker Version ID: [0-9a-f-]+' | awk '{print $4}')
          PREVIEW_URL=$(echo "$LOG" | grep -oE 'Version Preview URL: https?://[^[:space:]]+' | awk '{print $4}')
          BRANCH_PREVIEW_URL=$(echo "$LOG" | grep -oE 'Version Preview Alias URL: https?://[^[:space:]]+' | awk '{print $5}')
          echo "version_id=$VERSION_ID" >> "$GITHUB_OUTPUT"
          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "branch_preview_url=$BRANCH_PREVIEW_URL" >> "$GITHUB_OUTPUT"

      - name: Resolve staging namespace retention set
        id: staging_namespaces
        uses: actions/github-script@v8
        with:
          script: |
            function normalizeNamespace(value) {
              if (typeof value !== 'string') return null;
              const trimmed = value.trim();
              if (!trimmed) return null;
              const normalized = trimmed
                .toLowerCase()
                .replace(/[^a-z0-9_]+/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_+|_+$/g, '');
              return normalized || null;
            }

            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            const published = releases
              .filter((release) => !release.draft)
              .sort((a, b) => {
                const aDate = new Date(a.published_at || a.created_at || 0).getTime();
                const bDate = new Date(b.published_at || b.created_at || 0).getTime();
                return bDate - aDate;
              });

            const allNamespaces = [];
            for (const release of published) {
              const namespace = normalizeNamespace(release.tag_name);
              if (namespace) {
                allNamespaces.push(namespace);
              }
            }

            const uniqueNamespaces = [...new Set(allNamespaces)];
            const keepNamespaces = uniqueNamespaces.slice(0, 10);

            core.info(
              `Staging namespace retention: keep=${keepNamespaces.length} total_candidates=${uniqueNamespaces.length}`
            );
            core.setOutput('all', JSON.stringify(uniqueNamespaces));
            core.setOutput('keep', JSON.stringify(keepNamespaces));

      - name: Adding Version ID to Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
          NEW_NOTES: |
            <!-- preview-url -->
            | Key | Value |
            |---|---|
            | Cloudflare Worker Version ID | ${{ steps.deploy.outputs.version_id }} |
            | Preview URL | ${{ steps.deploy.outputs.preview_url }} |
            | Branch Preview URL | ${{ steps.deploy.outputs.branch_preview_url }} |
        run: |
          # Get the existing body of the release
          EXISTING_BODY=$(gh release view "$TAG" --repo="$GITHUB_REPOSITORY" --json body --jq .body)
          
          # Combine existing and new notes
          UPDATED_BODY="$NEW_NOTES"$'\n\n'"$EXISTING_BODY"
          # Save metadata.json and upload it to the release
          cat <<'EOF' > metadata.json
          {"version_id":"${{ steps.deploy.outputs.version_id }}","preview_url":"${{ steps.deploy.outputs.preview_url }}","branch_preview_url":"${{ steps.deploy.outputs.branch_preview_url }}"}
          EOF
          gh release upload "$TAG" metadata.json --repo="$GITHUB_REPOSITORY" --clobber
          # Edit the release with the updated notes
          gh release edit "$TAG" --repo="$GITHUB_REPOSITORY" --notes "$UPDATED_BODY"

      - name: Remove old staging FlexSearch tables
        if: ${{ steps.staging_namespaces.outputs.all != '[]' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          FLEXSEARCH_DB_ENV: production
          FLEXSEARCH_CANDIDATE_NAMESPACES: ${{ steps.staging_namespaces.outputs.all }}
          FLEXSEARCH_KEEP_NAMESPACES: ${{ steps.staging_namespaces.outputs.keep }}
        run: node scripts/ci/cleanup-flexsearch-tables.mjs
