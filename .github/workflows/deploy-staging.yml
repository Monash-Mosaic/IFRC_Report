name: Deploy to Cloudflare (Production)

on:
  release:
    types: [published]

permissions:
  contents: write # Required to edit releases

jobs:
  deploy_staging:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Cloudflare (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          LOG=$(npm run upload -- --env="" --preview-alias staging 2>&1 | tee /dev/stderr)
          VERSION_ID=$(echo "$LOG" | grep -oE 'Worker Version ID: [0-9a-f-]+' | awk '{print $4}')
          PREVIEW_URL=$(echo "$LOG" | grep -oE 'Version Preview URL: https?://[^[:space:]]+' | awk '{print $5}')
          BRANCH_PREVIEW_URL=$(echo "$LOG" | grep -oE 'Version Preview Alias URL: https?://[^[:space:]]+' | awk '{print $5}')
          echo "version_id=$VERSION_ID" >> "$GITHUB_OUTPUT"
          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "branch_preview_url=$BRANCH_PREVIEW_URL" >> "$GITHUB_OUTPUT"

      - name: Adding Version ID to Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
          NEW_NOTES: $'\n\n<!-- preview-url -->\n| Key | Value |\n|---|---|\n| Cloudflare Worker Version ID | '"${{ steps.deploy.outputs.version_id }}"' |\n| Preview URL | '"${{ steps.deploy.outputs.preview_url }}"' |\n| Branch Preview URL | '"${{ steps.deploy.outputs.branch_preview_url }}"' |'
        run: |
          # Get the existing body of the release
          EXISTING_BODY=$(gh release view "$TAG" --repo="$GITHUB_REPOSITORY" --json body --jq .body)
          
          # Combine existing and new notes
          UPDATED_BODY="$NEW_NOTES
          $EXISTING_BODY"
          # Save metadata.json and upload it to the release
          cat <<'EOF' > metadata.json
          {"version_id":"${{ steps.deploy.outputs.version_id }}","preview_url":"${{ steps.deploy.outputs.preview_url }}","branch_preview_url":"${{ steps.deploy.outputs.branch_preview_url }}"}
          EOF
          gh release upload "$TAG" metadata.json --repo="$GITHUB_REPOSITORY" --clobber
          # Edit the release with the updated notes
          gh release edit "$TAG" --repo="$GITHUB_REPOSITORY" --body "$UPDATED_BODY"