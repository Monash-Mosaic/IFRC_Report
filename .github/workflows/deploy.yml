name: Deploy to Infomaniak

on:
  push:
    tags:
      - 'v*.*.*'  # Matches vX.Y.Z pattern (e.g., v1.2.3)

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed to check if tag is on main
      
      - name: Verify tag is on main branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Checking if tag $TAG_NAME is reachable from main branch..."
          
          # Fetch main branch
          git fetch origin main:main || git fetch origin master:main
          
          # Check if the tagged commit is in main branch history
          if ! git branch -r --contains "$TAG_NAME" | grep -q "origin/main"; then
            echo "Error: Tag $TAG_NAME is not reachable from main branch"
            echo "Please ensure the tag is created on a commit that exists in main branch"
            exit 1
          fi
          
          echo "âœ“ Tag $TAG_NAME is valid for deployment"
      
      - name: Deploy via SFTP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          key: ${{ secrets.SFTP_SSH_KEY }}
          source: "."
          target: ${{ secrets.SFTP_REMOTE_PATH }}
          strip_components: 0
          rm: false
          # Exclude unnecessary files from deployment
          exclude: |
            .git
            .github
            node_modules
            .next/cache
            tests
            *.test.js
            *.test.js.snap
            .gitignore
            .prettierrc
            eslint.config.mjs
            jest.config.js
            jest.setup.js
            tsconfig.json
            jsconfig.json
            README.md
            scripts
