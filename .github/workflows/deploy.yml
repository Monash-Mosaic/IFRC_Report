name: Deploy to Cloudflare (Production)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy to production (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  deploy_production:
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag }}
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve version id from metadata.json asset
        id: version
        uses: actions/github-script@v8
        with:
          script: |
            const tag = '${{ inputs.tag }}';
            const { owner, repo } = context.repo;

            const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
            const assets = await github.rest.repos.listReleaseAssets({
              owner,
              repo,
              release_id: release.data.id,
            });

            const asset = assets.data.find(a => a.name === 'metadata.json');
            if (!asset) {
              core.setFailed('metadata.json not found in release assets.');
              return;
            }

            const response = await github.request(asset.url, {
              headers: { Accept: 'application/octet-stream' },
            });

            const metadata = JSON.parse(Buffer.from(response.data).toString('utf8'));
            const versionId = metadata.version_id || metadata.versionId;

            if (!versionId) {
              core.setFailed('version_id not found in metadata.json.');
              return;
            }

            core.setOutput('version_id', versionId);

      - name: Deploy to Cloudflare (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VERSION_ID: ${{ steps.version.outputs.version_id }}
        run: npx wrangler versions deploy -y "$VERSION_ID"

      - name: Purge Cloudflare CDN cache
        if: ${{ vars.CLOUDFLARE_ZONE_ID != '' }}
        uses: nathanvaughn/actions-cloudflare-purge@v4
        with:
          cf_zone: ${{ vars.CLOUDFLARE_ZONE_ID }}
          cf_auth: ${{ secrets.CLOUDFLARE_API_TOKEN }}
