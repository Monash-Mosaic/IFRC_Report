name: Deploy to Cloudflare (Production)

# on:
#   # TODO: enable when ready
#   # release:
#   #   types: [published]
#   push:
#     branches: [main, feat/production-setup]
#     # tags:
#     #   - '*' # Triggers for any tag name

on:
  push:
    tags:
      - 'v*.*.*' # Triggers for semver tags like v1.2.3, v1.2.3-rc.1
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy to production (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  deploy_production:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve version id from tag
        id: version
        run: |
          TAG_NAME="${{ inputs.tag }}"
          echo "Resolving version_id from tag: $TAG_NAME"
          TAG_BODY=$(git cat-file -p "refs/tags/$TAG_NAME" | sed -n '1,/^$/!p')
          VERSION_ID=$(echo "$TAG_BODY" | grep -oE 'version_id:[[:space:]]*[0-9a-f-]+' | awk '{print $2}')
          if [ -z "$VERSION_ID" ]; then
            echo "Error: version_id not found in tag annotation. Expected 'version_id: <uuid>'."
            exit 1
          fi
          echo "version_id=$VERSION_ID" >> "$GITHUB_OUTPUT"

      - name: Deploy to Cloudflare (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VERSION_ID: ${{ steps.version.outputs.version_id }}
        run: npx wrangler versions deploy -y "$VERSION_ID"

      - name: Purge Cloudflare CDN cache
        if: ${{ vars.CLOUDFLARE_ZONE_ID != '' }}
        uses: nathanvaughn/actions-cloudflare-purge@master
        with:
          cf_zone: ${{ vars.CLOUDFLARE_ZONE_ID }}
          cf_auth: ${{ secrets.CLOUDFLARE_API_TOKEN }}
