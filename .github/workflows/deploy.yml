name: Deploy to Cloudflare (Production)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy to production (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  deploy_production:
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve version id from release notes
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ inputs.tag }}';
            const { owner, repo } = context.repo;
            const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
            const body = release.data.body || '';
            const match = body.match(/Cloudflare Worker Version ID\s*\|\s*["']?([0-9a-f-]+)["']?\s*\|/i);

            if (!match) {
              core.setFailed("version_id not found in release notes. Expected 'version_id: <uuid>'.");
              return;
            }
            core.setOutput('version_id', match[1]);

      - name: Deploy to Cloudflare (production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VERSION_ID: ${{ steps.version.outputs.version_id }}
        run: npx wrangler versions deploy -y "$VERSION_ID"

      - name: Purge Cloudflare CDN cache
        if: ${{ vars.CLOUDFLARE_ZONE_ID != '' }}
        uses: nathanvaughn/actions-cloudflare-purge@master
        with:
          cf_zone: ${{ vars.CLOUDFLARE_ZONE_ID }}
          cf_auth: ${{ secrets.CLOUDFLARE_API_TOKEN }}
